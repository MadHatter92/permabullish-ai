# Permabullish Render Blueprint
# AI Stock Researcher - Single Product Deployment
# Deploy with: render blueprint sync

services:
  # ============================================
  # PRODUCTION SERVICES
  # ============================================

  # Production API
  - type: web
    name: permabullish-api
    runtime: python
    plan: starter  # $7/month
    region: oregon
    branch: main
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn main:app --workers 2 --worker-class uvicorn.workers.UvicornWorker --timeout 120 --bind 0.0.0.0:$PORT
    healthCheckPath: /api/health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: permabullish-db
          property: connectionString
      - key: ENVIRONMENT
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: GOOGLE_REDIRECT_URI
        value: https://permabullish-api.onrender.com/api/auth/google/callback
      - key: FRONTEND_URL
        value: https://permabullish.com
      - key: CASHFREE_APP_ID
        sync: false
      - key: CASHFREE_SECRET_KEY
        sync: false
      - key: CASHFREE_ENV
        value: production
      - key: SENTRY_DSN
        sync: false

  # Stock Research Frontend (Static)
  - type: web
    name: permabullish-web
    runtime: static
    branch: main
    rootDir: frontend
    staticPublishPath: .
    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=3600
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

  # ============================================
  # STAGING SERVICES
  # ============================================

  # Staging API
  - type: web
    name: permabullish-api-staging
    runtime: python
    plan: starter
    region: oregon
    branch: staging
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn main:app --workers 1 --worker-class uvicorn.workers.UvicornWorker --timeout 120 --bind 0.0.0.0:$PORT
    healthCheckPath: /api/health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: permabullish-db-staging
          property: connectionString
      - key: ENVIRONMENT
        value: staging
      - key: SECRET_KEY
        generateValue: true
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: GOOGLE_REDIRECT_URI
        value: https://permabullish-api-staging.onrender.com/api/auth/google/callback
      - key: FRONTEND_URL
        value: https://permabullish-web-staging.onrender.com
      - key: CASHFREE_APP_ID
        sync: false
      - key: CASHFREE_SECRET_KEY
        sync: false
      - key: CASHFREE_ENV
        value: sandbox
      - key: SENTRY_DSN
        sync: false

  # Staging Frontend (Static)
  - type: web
    name: permabullish-web-staging
    runtime: static
    branch: staging
    rootDir: frontend
    staticPublishPath: .
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

  # ============================================
  # CRON JOBS
  # ============================================

  # Daily Usage Report (runs at 9:00 AM IST / 3:30 AM UTC daily)
  - type: cron
    name: permabullish-daily-report
    runtime: python
    schedule: "30 3 * * *"
    region: oregon
    branch: main
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: python scripts/send_user_report.py daily
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: permabullish-db
          property: connectionString
      - key: REPORT_EMAIL_TO
        value: mail@mayaskara.com
      - key: RESEND_API_KEY
        sync: false

  # Weekly Usage Report (runs Monday at 9:00 AM IST / 3:30 AM UTC)
  - type: cron
    name: permabullish-weekly-report
    runtime: python
    schedule: "30 3 * * 1"
    region: oregon
    branch: main
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: python scripts/send_user_report.py weekly
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: permabullish-db
          property: connectionString
      - key: REPORT_EMAIL_TO
        value: mail@mayaskara.com
      - key: RESEND_API_KEY
        sync: false

  # Re-engagement Emails (daily at 10 AM IST / 4:30 AM UTC)
  - type: cron
    name: permabullish-reengagement-emails
    runtime: python
    plan: starter
    schedule: "30 4 * * *"
    region: oregon
    branch: main
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: python scripts/send_reengagement_emails.py
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: permabullish-db
          property: connectionString
      - key: RESEND_API_KEY
        sync: false

  # Expiry Reminder Emails (daily at 10:30 AM IST / 5 AM UTC)
  - type: cron
    name: permabullish-expiry-emails
    runtime: python
    plan: starter
    schedule: "0 5 * * *"
    region: oregon
    branch: main
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: python scripts/send_expiry_emails.py
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: permabullish-db
          property: connectionString
      - key: RESEND_API_KEY
        sync: false

  # Monthly Fundamentals Sync (1st of month at midnight UTC)
  - type: cron
    name: permabullish-fundamentals-sync
    runtime: python
    plan: starter
    schedule: "0 0 1 * *"
    region: oregon
    branch: main
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: python scripts/fundamentals_sync.py
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: permabullish-db
          property: connectionString

databases:
  # Production Database
  - name: permabullish-db
    plan: basic-256mb  # $6/month
    region: oregon
    postgresMajorVersion: 15

  # Staging Database
  - name: permabullish-db-staging
    plan: free
    region: oregon
    postgresMajorVersion: 15

# Notes:
#
# Environment Variables to set manually in Render Dashboard:
# - ANTHROPIC_API_KEY: Claude API key for AI report generation
# - GOOGLE_CLIENT_ID: Google OAuth client ID
# - GOOGLE_CLIENT_SECRET: Google OAuth client secret
# - CASHFREE_APP_ID: Cashfree payment gateway app ID
# - CASHFREE_SECRET_KEY: Cashfree payment gateway secret
# - RESEND_API_KEY: Resend API key for email reports
# - SENTRY_DSN: Sentry error tracking DSN (from sentry.io)
#
# Note: CASHFREE_ENV is pre-set:
#   - Production: "production"
#   - Staging: "sandbox" (use test credentials from Cashfree)
#
# Cost Estimate:
# - Production API (Starter): $7/month
# - Production DB (Starter): $7/month
# - Staging API (Starter): $7/month
# - Staging DB (Free): $0/month
# - Static Sites: $0/month
# - Cron Jobs: Included
# - Total: ~$21/month + Claude API usage
