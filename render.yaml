# Permabullish Render Blueprint
# Deploy with: render blueprint sync
#
# Architecture:
# - Production API (Starter plan) + DB (Basic plan)
# - Staging API (Free tier) + DB (Free tier)
# - Static frontend sites (Free tier)

services:
  # ============================================
  # PRODUCTION SERVICES
  # ============================================

  # Production API
  - type: web
    name: permabullish-api
    runtime: python
    plan: starter  # $7/month
    region: oregon
    branch: main
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn main:app --workers 2 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT
    healthCheckPath: /api/health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: permabullish-db
          property: connectionString
      - key: ENVIRONMENT
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: ANTHROPIC_API_KEY
        sync: false  # Set manually in dashboard
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: GOOGLE_REDIRECT_URI
        value: https://permabullish-api.onrender.com/api/auth/google/callback
      - key: FRONTEND_URL
        value: https://permabullish-web.onrender.com
      - key: MONTHLY_REPORT_LIMIT
        value: "20"
      - key: ANONYMOUS_REPORT_LIMIT
        value: "3"

  # Production Frontend (Static)
  - type: web
    name: permabullish-web
    runtime: static
    branch: main
    rootDir: frontend
    staticPublishPath: .
    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=3600
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

  # ============================================
  # STAGING SERVICES
  # ============================================

  # Staging API
  - type: web
    name: permabullish-api-staging
    runtime: python
    plan: starter  # Using starter for staging too (free tier limited)
    region: oregon
    branch: staging
    rootDir: backend
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn main:app --workers 1 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT
    healthCheckPath: /api/health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: permabullish-db-staging
          property: connectionString
      - key: ENVIRONMENT
        value: staging
      - key: SECRET_KEY
        generateValue: true
      - key: ANTHROPIC_API_KEY
        sync: false  # Set manually (can use same as prod or separate)
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: GOOGLE_REDIRECT_URI
        value: https://permabullish-api-staging.onrender.com/api/auth/google/callback
      - key: FRONTEND_URL
        value: https://permabullish-web-staging.onrender.com
      - key: MONTHLY_REPORT_LIMIT
        value: "20"
      - key: ANONYMOUS_REPORT_LIMIT
        value: "3"

  # Staging Frontend (Static)
  - type: web
    name: permabullish-web-staging
    runtime: static
    branch: staging
    rootDir: frontend
    staticPublishPath: .
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

# ============================================
# DATABASES
# ============================================

databases:
  # Production Database
  - name: permabullish-db
    plan: standard  # $20/month
    region: oregon
    postgresMajorVersion: 15

  # Staging Database
  - name: permabullish-db-staging
    plan: free  # Free tier (90-day expiry)
    region: oregon
    postgresMajorVersion: 15

# ============================================
# NOTES
# ============================================
#
# Deployment Workflow:
# 1. Development: Work locally with SQLite
# 2. Test: Push to 'staging' branch -> auto-deploys to staging
# 3. Review: Test on staging.permabullish.com
# 4. Deploy: Merge staging -> main -> auto-deploys to production
#
# Environment Variables to set manually in Render Dashboard:
# - ANTHROPIC_API_KEY: Your Claude API key
# - GOOGLE_CLIENT_ID: Google OAuth client ID
# - GOOGLE_CLIENT_SECRET: Google OAuth client secret
#
# Custom Domain Setup (after initial deploy):
# 1. Add custom domain in Render dashboard
# 2. Update GOOGLE_REDIRECT_URI and FRONTEND_URL
# 3. Update CORS_ORIGINS in config.py if needed
#
# Cost Estimate:
# - Production API (Starter): $7/month
# - Production DB (Standard): $20/month
# - Staging API (Starter): $7/month
# - Staging DB (Free): $0/month
# - Static Sites: $0/month
# - Total: ~$34/month + Claude API usage
