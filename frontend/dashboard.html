<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Permabullish</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Serif+Display&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        .gradient-header {
            background: linear-gradient(135deg, #102a43 0%, #1e3a5f 100%);
        }
        body {
            font-family: 'DM Sans', 'Inter', system-ui, sans-serif;
        }
        .font-display {
            font-family: 'DM Serif Display', Georgia, serif;
        }
        .tab-active {
            border-bottom: 2px solid #e8913a;
            color: #1e3a5f;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }

        /* Polish: Smooth transitions */
        a, button, input, [class*="bg-white"], [class*="rounded"] {
            transition: all 0.2s ease-out;
        }

        /* Polish: Subtle hover elevation for cards */
        .bg-white.rounded-xl:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        button:active {
            transform: translateY(0);
        }

        /* Polish: Content fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        .fade-in-delay {
            opacity: 0;
            animation: fadeIn 0.4s ease-out 0.1s forwards;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-header text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center min-w-0">
                    <h1 class="text-base sm:text-xl font-display truncate">
                        <span>Perma</span><span class="text-[#e8913a]">bullish</span>
                    </h1>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4 flex-shrink-0">
                    <div class="flex items-center space-x-2 sm:space-x-3">
                        <img id="userAvatar" src="" alt="" class="hidden w-7 h-7 sm:w-8 sm:h-8 rounded-full border-2 border-white/30">
                        <span id="userName" class="hidden sm:inline text-sm text-[#9fb3c8] max-w-32 truncate"></span>
                    </div>
                    <button onclick="logout()" class="text-sm bg-white/10 hover:bg-white/20 px-3 sm:px-4 py-2 rounded-lg transition-all">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 fade-in">
        <!-- Limit Expired Banner (persistent, for users with no reports left) -->
        <div id="expiredBanner" class="hidden bg-gradient-to-r from-red-600 to-red-500 rounded-xl p-4 mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 shadow-lg">
            <div class="flex items-center space-x-3">
                <div class="bg-white/20 rounded-full p-2 flex-shrink-0">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-white font-semibold text-sm sm:text-base" id="expiredBannerTitle">Your report limit has been reached</p>
                    <p class="text-white/80 text-xs sm:text-sm" id="expiredBannerText">Upgrade your plan to continue generating AI-powered research reports.</p>
                </div>
            </div>
            <a href="pricing.html" class="bg-white text-red-600 px-5 py-2.5 rounded-lg font-semibold hover:bg-red-50 transition-all text-sm whitespace-nowrap shadow-md">
                Upgrade Now
            </a>
        </div>

        <!-- Upgrade Banner (hidden by default, for low reports warning) -->
        <div id="upgradeBanner" class="hidden bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl p-4 mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
            <div class="flex items-center space-x-3">
                <svg class="w-6 h-6 text-white flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <p class="text-white font-medium text-sm sm:text-base" id="upgradeBannerText">You're running low on reports! Upgrade for more.</p>
            </div>
            <a href="pricing.html" class="bg-white text-orange-600 px-4 py-2 rounded-lg font-medium hover:bg-orange-50 transition-all text-sm whitespace-nowrap">
                Upgrade Now
            </a>
        </div>

        <!-- Usage Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
            <!-- Subscription Tier -->
            <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs sm:text-sm text-gray-500">Current Plan</p>
                        <p class="text-lg sm:text-2xl font-bold text-[#1e3a5f]" id="tierName">Free</p>
                    </div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                    </div>
                </div>
                <a href="subscription.html" class="mt-2 sm:mt-3 inline-block text-xs sm:text-sm text-[#e8913a] hover:underline" id="manageLink">Manage</a>
            </div>

            <!-- Reports Used -->
            <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs sm:text-sm text-gray-500">Reports Used</p>
                        <p class="text-xl sm:text-3xl font-bold text-[#1e3a5f]"><span id="reportsUsed">0</span>/<span id="reportsLimit">3</span></p>
                    </div>
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-[#fdecd4] rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-[#e8913a]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-3 sm:mt-4">
                    <div class="w-full bg-gray-200 rounded-full h-1.5 sm:h-2">
                        <div id="usageBar" class="bg-[#e8913a] h-1.5 sm:h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Reports Remaining -->
            <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs sm:text-sm text-gray-500">Remaining</p>
                        <p class="text-xl sm:text-3xl font-bold" id="reportsRemaining">3</p>
                    </div>
                    <div id="remainingIcon" class="w-10 h-10 sm:w-12 sm:h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </div>
                </div>
                <p class="mt-2 sm:mt-4 text-xs sm:text-sm text-gray-500" id="resetInfo">Resets on <span id="resetDate">-</span></p>
            </div>

            <!-- Generate CTA -->
            <div class="bg-gradient-to-r from-[#e8913a] to-[#d97316] rounded-xl shadow-lg p-4 sm:p-6 text-white">
                <h3 class="font-bold text-base sm:text-lg mb-1 sm:mb-2">Generate Report</h3>
                <p class="text-white/80 text-xs sm:text-sm mb-3 sm:mb-4 hidden sm:block">AI-powered equity research</p>
                <a href="generate.html" class="inline-flex items-center gap-2 bg-white text-[#e8913a] px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg font-bold hover:bg-gray-100 transition-all text-sm sm:text-base shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    New Report
                </a>
            </div>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="flex space-x-8">
                <button onclick="showTab('reports')" id="tab-reports" class="tab-active pb-3 px-1 text-sm font-medium transition-all">
                    Report History
                </button>
                <button onclick="showTab('watchlist')" id="tab-watchlist" class="tab-inactive pb-3 px-1 text-sm font-medium transition-all hover:text-gray-700">
                    Watchlist
                </button>
            </nav>
        </div>

        <!-- Report History Tab -->
        <div id="panel-reports" class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Recent Reports</h2>
                <div class="flex items-center text-sm text-gray-500">
                    <span class="inline-block w-2 h-2 rounded-full bg-yellow-500 mr-2"></span>
                    Outdated (&gt;15 days)
                </div>
            </div>

            <div id="reportsLoading" class="p-8 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#e8913a] mx-auto"></div>
                <p class="text-gray-500 mt-2">Loading reports...</p>
            </div>

            <div id="reportsEmpty" class="hidden p-8 text-center">
                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-1">No reports yet</h3>
                <p class="text-gray-500 mb-4">Generate your first equity research report</p>
                <a href="generate.html" class="inline-block bg-[#e8913a] text-white px-4 py-2 rounded-lg font-medium hover:bg-[#d97316] transition-all">
                    Generate Report
                </a>
            </div>

            <div id="reportsList" class="hidden divide-y divide-gray-100">
                <!-- Reports will be inserted here -->
            </div>
        </div>

        <!-- Watchlist Tab -->
        <div id="panel-watchlist" class="hidden bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">My Watchlist</h2>
                <a href="generate.html" class="text-sm text-[#e8913a] hover:underline">+ Add Stock</a>
            </div>

            <div id="watchlistLoading" class="p-8 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#e8913a] mx-auto"></div>
                <p class="text-gray-500 mt-2">Loading watchlist...</p>
            </div>

            <div id="watchlistEmpty" class="hidden p-8 text-center">
                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-1">Your watchlist is empty</h3>
                <p class="text-gray-500 mb-4">Add stocks to track and generate reports</p>
                <a href="generate.html" class="inline-block bg-[#e8913a] text-white px-4 py-2 rounded-lg font-medium hover:bg-[#d97316] transition-all">
                    Search Stocks
                </a>
            </div>

            <div id="watchlistList" class="hidden divide-y divide-gray-100">
                <!-- Watchlist items will be inserted here -->
            </div>
        </div>
    </main>

    <!-- Share Toast Notification -->
    <div id="shareToast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2">
        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span>Link copied to clipboard!</span>
    </div>

    <script src="config.js"></script>
    <script>
        let token = localStorage.getItem('token');
        let currentTab = 'reports';

        // Check for OAuth callback token in URL
        const urlParams = new URLSearchParams(window.location.search);
        const callbackToken = urlParams.get('token');

        if (callbackToken) {
            token = callbackToken;
            localStorage.setItem('token', callbackToken);

            fetch(`${API_BASE}/auth/me`, {
                headers: { 'Authorization': `Bearer ${callbackToken}` }
            })
            .then(res => res.json())
            .then(user => {
                localStorage.setItem('user', JSON.stringify(user));
                window.history.replaceState({}, document.title, 'dashboard.html');
                location.reload();
            })
            .catch(() => {
                window.history.replaceState({}, document.title, 'dashboard.html');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!token) {
                window.location.href = 'index.html';
                return;
            }

            const user = JSON.parse(localStorage.getItem('user') || '{}');
            document.getElementById('userName').textContent = user.full_name || user.email || '';

            if (user.avatar_url) {
                const avatarEl = document.getElementById('userAvatar');
                avatarEl.src = user.avatar_url;
                avatarEl.classList.remove('hidden');
            }

            loadUsage();
            loadReports();
        });

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        function showTab(tab) {
            currentTab = tab;

            // Update tab styles
            document.getElementById('tab-reports').className = tab === 'reports' ? 'tab-active pb-3 px-1 text-sm font-medium transition-all' : 'tab-inactive pb-3 px-1 text-sm font-medium transition-all hover:text-gray-700';
            document.getElementById('tab-watchlist').className = tab === 'watchlist' ? 'tab-active pb-3 px-1 text-sm font-medium transition-all' : 'tab-inactive pb-3 px-1 text-sm font-medium transition-all hover:text-gray-700';

            // Show/hide panels
            document.getElementById('panel-reports').classList.toggle('hidden', tab !== 'reports');
            document.getElementById('panel-watchlist').classList.toggle('hidden', tab !== 'watchlist');

            // Load data for tab
            if (tab === 'watchlist') {
                loadWatchlist();
            }
        }

        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });

            if (response.status === 401) {
                logout();
                throw new Error('Session expired');
            }

            return response;
        }

        async function loadUsage() {
            try {
                // Fetch subscription status (includes usage + expiration info)
                const response = await apiCall('/subscription/status');
                const status = await response.json();

                // Update tier name
                document.getElementById('tierName').textContent = status.tier_name || 'Free';

                // Hide upgrade link for paid tiers
                if (status.tier !== 'free') {
                    document.getElementById('upgradeLink').textContent = 'Manage';
                }

                // Update usage numbers
                document.getElementById('reportsUsed').textContent = status.reports_used;
                document.getElementById('reportsLimit').textContent = status.reports_limit;
                document.getElementById('reportsRemaining').textContent = status.reports_remaining;

                // Update reset info based on lifetime vs monthly
                const resetInfo = document.getElementById('resetInfo');
                if (status.is_lifetime) {
                    resetInfo.innerHTML = '<span class="text-amber-600">Lifetime limit</span>';
                } else if (status.reset_date) {
                    resetInfo.innerHTML = `Resets on <span id="resetDate">${status.reset_date}</span>`;
                }

                // Update usage bar
                const percentage = (status.reports_used / status.reports_limit) * 100;
                document.getElementById('usageBar').style.width = `${percentage}%`;

                // Color code remaining reports
                const remainingEl = document.getElementById('reportsRemaining');
                const iconEl = document.getElementById('remainingIcon');
                if (status.reports_remaining === 0 || status.is_expired) {
                    remainingEl.classList.remove('text-green-600', 'text-amber-600');
                    remainingEl.classList.add('text-red-600');
                    iconEl.classList.remove('bg-green-100');
                    iconEl.classList.add('bg-red-100');
                    iconEl.querySelector('svg').classList.remove('text-green-600');
                    iconEl.querySelector('svg').classList.add('text-red-600');
                } else if (status.reports_remaining <= 2) {
                    remainingEl.classList.remove('text-green-600', 'text-red-600');
                    remainingEl.classList.add('text-amber-600');
                    iconEl.classList.remove('bg-green-100');
                    iconEl.classList.add('bg-amber-100');
                    iconEl.querySelector('svg').classList.remove('text-green-600');
                    iconEl.querySelector('svg').classList.add('text-amber-600');
                } else {
                    remainingEl.classList.add('text-green-600');
                }

                // Show expired banner if subscription expired OR no reports left
                const expiredBanner = document.getElementById('expiredBanner');
                const upgradeBanner = document.getElementById('upgradeBanner');

                if (status.is_expired) {
                    // Paid subscription expired
                    document.getElementById('expiredBannerTitle').textContent = 'Your subscription has expired';
                    document.getElementById('expiredBannerText').textContent = 'Renew your plan to continue generating AI-powered research reports.';
                    expiredBanner.classList.remove('hidden');
                    upgradeBanner.classList.add('hidden');
                } else if (status.reports_remaining === 0) {
                    // Free tier exhausted OR monthly limit reached
                    if (status.tier === 'free') {
                        document.getElementById('expiredBannerTitle').textContent = "You've used all your free reports";
                        document.getElementById('expiredBannerText').textContent = 'Upgrade to a paid plan to continue generating AI-powered research reports.';
                    } else {
                        document.getElementById('expiredBannerTitle').textContent = 'Monthly report limit reached';
                        document.getElementById('expiredBannerText').textContent = `Your limit resets on ${status.reset_date}. Upgrade for more reports.`;
                    }
                    expiredBanner.classList.remove('hidden');
                    upgradeBanner.classList.add('hidden');
                } else if (status.tier === 'free' && status.reports_remaining <= 1) {
                    // Low on reports warning (amber banner)
                    upgradeBanner.classList.remove('hidden');
                    document.getElementById('upgradeBannerText').textContent =
                        `Only ${status.reports_remaining} free report${status.reports_remaining > 1 ? 's' : ''} left! Upgrade for more.`;
                }

            } catch (error) {
                console.error('Failed to load usage:', error);
            }
        }

        async function loadReports() {
            const loadingEl = document.getElementById('reportsLoading');
            const emptyEl = document.getElementById('reportsEmpty');
            const listEl = document.getElementById('reportsList');

            try {
                const response = await apiCall('/reports');
                const reports = await response.json();

                loadingEl.classList.add('hidden');

                if (reports.length === 0) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                listEl.innerHTML = reports.map(report => `
                    <div class="p-3 sm:p-4 hover:bg-gray-50 transition-all">
                        <div class="flex flex-col gap-2 sm:gap-0 sm:flex-row sm:items-center sm:justify-between">
                            <div class="flex items-center space-x-3 min-w-0 flex-1">
                                <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg flex items-center justify-center font-bold text-white text-sm sm:text-base flex-shrink-0 ${getRecommendationColor(report.recommendation)}">
                                    ${report.recommendation?.charAt(0) || 'H'}
                                </div>
                                <div class="min-w-0 flex-1">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <h3 class="font-medium text-gray-900 text-sm sm:text-base truncate max-w-[150px] sm:max-w-none">${report.company_name}</h3>
                                        ${report.is_outdated ? '<span class="px-1.5 py-0.5 text-xs bg-yellow-100 text-yellow-800 rounded-full whitespace-nowrap">Outdated</span>' : ''}
                                    </div>
                                    <p class="text-xs sm:text-sm text-gray-500">${report.ticker} | ${formatDate(report.generated_at)}</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between pl-11 sm:pl-0">
                                <div class="flex items-center gap-3 sm:gap-4">
                                    <div class="sm:hidden text-xs text-gray-500">
                                        AI: <span class="font-medium text-gray-900">₹${report.ai_target_price?.toFixed(0) || '-'}</span>
                                    </div>
                                    <div class="text-right hidden sm:block">
                                        <p class="font-medium text-gray-900">₹${report.ai_target_price?.toFixed(0) || '-'}</p>
                                        <p class="text-sm text-gray-500">AI Target</p>
                                    </div>
                                    ${report.user_target_price ? '<div class="text-right hidden sm:block"><p class="font-medium text-[#e8913a]">₹' + report.user_target_price?.toFixed(0) + '</p><p class="text-sm text-gray-500">Your Target</p></div>' : ''}
                                </div>
                                <div class="flex space-x-1 flex-shrink-0">
                                    <button onclick="toggleReportWatchlist('${report.ticker}', '${report.exchange || 'NSE'}', '${report.company_name?.replace(/'/g, "\\'")}', this)"
                                        class="p-2 text-gray-400 hover:text-[#e8913a] hover:bg-[#fdecd4] rounded-lg transition-all watchlist-btn"
                                        data-ticker="${report.ticker}" data-exchange="${report.exchange || 'NSE'}" title="Add to Watchlist">
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="shareReport(${report.report_cache_id}, '${report.company_name?.replace(/'/g, "\\'")}')"
                                        class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-all" title="Share Report">
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                                        </svg>
                                    </button>
                                    <a href="report.html?id=${report.report_cache_id}" class="p-2 text-[#e8913a] hover:bg-[#fdecd4] rounded-lg transition-all" title="View Report">
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </a>
                                    ${report.is_outdated ? '<a href="generate.html?ticker=' + report.ticker + '&exchange=' + report.exchange + '&regenerate=true" class="p-2 text-yellow-600 hover:bg-yellow-50 rounded-lg transition-all" title="Regenerate"><svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></a>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                listEl.classList.remove('hidden');

            } catch (error) {
                console.error('Failed to load reports:', error);
                loadingEl.innerHTML = '<p class="text-red-500 p-4">Failed to load reports</p>';
            }
        }

        async function loadWatchlist() {
            const loadingEl = document.getElementById('watchlistLoading');
            const emptyEl = document.getElementById('watchlistEmpty');
            const listEl = document.getElementById('watchlistList');

            loadingEl.classList.remove('hidden');
            emptyEl.classList.add('hidden');
            listEl.classList.add('hidden');

            try {
                const response = await apiCall('/watchlist');
                const watchlist = await response.json();

                loadingEl.classList.add('hidden');

                if (watchlist.length === 0) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                listEl.innerHTML = watchlist.map(item => `
                    <div class="px-3 py-2 sm:p-4 hover:bg-gray-50 transition-all">
                        <div class="flex items-center justify-between gap-2">
                            <!-- Left: Ticker info -->
                            <div class="flex items-center gap-2 min-w-0 flex-1">
                                <div class="w-6 h-6 sm:w-10 sm:h-10 rounded flex items-center justify-center font-bold text-xs sm:text-base flex-shrink-0 ${item.has_report ? getRecommendationColor(item.recommendation) + ' text-white' : 'bg-gray-200 text-gray-500'}">
                                    ${item.has_report ? (item.recommendation?.charAt(0) || '?') : item.ticker?.charAt(0) || '?'}
                                </div>
                                <div class="min-w-0 flex-1">
                                    <div class="flex items-center gap-1.5">
                                        <span class="font-semibold text-gray-900 text-sm">${item.ticker}</span>
                                        ${item.has_report && item.is_outdated ? '<span class="w-1.5 h-1.5 rounded-full bg-amber-400 sm:hidden" title="Outdated"></span>' : ''}
                                        ${!item.has_report ? '<span class="w-1.5 h-1.5 rounded-full bg-gray-300 sm:hidden" title="No report"></span>' : ''}
                                        <span class="hidden sm:inline text-xs text-gray-400">${item.exchange}</span>
                                        ${!item.has_report ? '<span class="hidden sm:inline px-1.5 py-0.5 text-xs bg-gray-100 text-gray-600 rounded-full">No report</span>' : ''}
                                        ${item.has_report && item.is_outdated ? '<span class="hidden sm:inline px-1.5 py-0.5 text-xs bg-yellow-100 text-yellow-800 rounded-full">Outdated</span>' : ''}
                                    </div>
                                    <p class="text-xs text-gray-500 truncate max-w-[120px] sm:max-w-none">${item.company_name || item.ticker}</p>
                                </div>
                            </div>
                            <!-- Right: Price + Actions -->
                            <div class="flex items-center gap-2 sm:gap-4 flex-shrink-0">
                                ${item.has_report ? '<span class="text-xs sm:text-sm font-medium text-gray-900">₹' + (item.ai_target_price?.toFixed(0) || '-') + '</span>' : ''}
                                <div class="flex items-center">
                                    ${item.has_report ? '<a href="report.html?id=' + item.report_cache_id + '" class="p-1.5 sm:p-2 text-[#e8913a] hover:bg-[#fdecd4] rounded-lg transition-all" title="View"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></a>' : '<a href="generate.html?ticker=' + item.ticker + '&exchange=' + item.exchange + '" class="px-2 py-1 text-xs bg-[#e8913a] text-white rounded hover:bg-[#d97316] transition-all">New</a>'}
                                    <button onclick="removeFromWatchlist('${item.ticker}', '${item.exchange}')" class="p-1.5 sm:p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all" title="Remove">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                listEl.classList.remove('hidden');

            } catch (error) {
                console.error('Failed to load watchlist:', error);
                loadingEl.innerHTML = '<p class="text-red-500 p-4">Failed to load watchlist</p>';
            }
        }

        async function removeFromWatchlist(ticker, exchange) {
            if (!confirm(`Remove ${ticker} from watchlist?`)) {
                return;
            }

            try {
                await apiCall(`/watchlist/${ticker}?exchange=${exchange}`, { method: 'DELETE' });
                loadWatchlist();
            } catch (error) {
                console.error('Failed to remove from watchlist:', error);
                alert('Failed to remove from watchlist');
            }
        }

        function getRecommendationColor(rec) {
            switch (rec?.toUpperCase()) {
                case 'STRONG BUY':
                case 'BUY': return 'bg-green-500';
                case 'STRONG SELL':
                case 'SELL': return 'bg-red-500';
                case 'HOLD':
                default: return 'bg-yellow-500';
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // Store watchlist tickers for quick lookup
        let watchlistTickers = new Set();

        async function loadWatchlistTickers() {
            try {
                const response = await apiCall('/watchlist');
                const watchlist = await response.json();
                watchlistTickers = new Set(watchlist.map(w => `${w.ticker}_${w.exchange}`));
                updateWatchlistButtonStates();
            } catch (error) {
                console.error('Failed to load watchlist tickers:', error);
            }
        }

        function updateWatchlistButtonStates() {
            document.querySelectorAll('.watchlist-btn').forEach(btn => {
                const ticker = btn.dataset.ticker;
                const exchange = btn.dataset.exchange || 'NSE';
                const key = `${ticker}_${exchange}`;
                const svg = btn.querySelector('svg');

                if (watchlistTickers.has(key)) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('text-[#e8913a]');
                    svg.setAttribute('fill', 'currentColor');
                    btn.title = 'In Watchlist';
                } else {
                    btn.classList.remove('text-[#e8913a]');
                    btn.classList.add('text-gray-400');
                    svg.setAttribute('fill', 'none');
                    btn.title = 'Add to Watchlist';
                }
            });
        }

        async function toggleReportWatchlist(ticker, exchange, companyName, btn) {
            const key = `${ticker}_${exchange}`;
            const isInWatchlist = watchlistTickers.has(key);

            btn.disabled = true;

            try {
                if (isInWatchlist) {
                    await apiCall(`/watchlist/${ticker}?exchange=${exchange}`, { method: 'DELETE' });
                    watchlistTickers.delete(key);
                } else {
                    await apiCall('/watchlist', {
                        method: 'POST',
                        body: JSON.stringify({ ticker, exchange, company_name: companyName })
                    });
                    watchlistTickers.add(key);
                }
                updateWatchlistButtonStates();
                // Refresh watchlist tab if visible
                if (!document.getElementById('panel-watchlist').classList.contains('hidden')) {
                    loadWatchlist();
                }
            } catch (error) {
                console.error('Failed to toggle watchlist:', error);
            } finally {
                btn.disabled = false;
            }
        }

        // Load watchlist tickers after reports load
        document.addEventListener('DOMContentLoaded', () => {
            // Original init is already called, add watchlist tickers load
            setTimeout(loadWatchlistTickers, 500);
        });

        // Share functionality
        function shareReport(reportId, companyName) {
            const shareUrl = window.location.origin + '/report.html?id=' + reportId;

            if (navigator.share) {
                navigator.share({
                    title: companyName + ' Research Report',
                    text: 'Check out this AI-powered stock research report from Permabullish',
                    url: shareUrl
                }).catch(() => copyToClipboard(shareUrl));
            } else {
                copyToClipboard(shareUrl);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showShareToast();
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showShareToast();
            });
        }

        function showShareToast() {
            const toast = document.getElementById('shareToast');
            if (toast) {
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3000);
            }
        }
    </script>
</body>
</html>
