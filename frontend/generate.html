<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Report - Permabullish</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Serif+Display&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        .gradient-header {
            background: linear-gradient(135deg, #102a43 0%, #1e3a5f 100%);
        }
        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }
        body {
            font-family: 'DM Sans', 'Inter', system-ui, sans-serif;
        }
        .font-display {
            font-family: 'DM Serif Display', Georgia, serif;
        }

        /* Polish: Smooth transitions */
        a, button, input, [class*="bg-white"], [class*="rounded"] {
            transition: all 0.2s ease-out;
        }

        /* Polish: Subtle hover elevation for cards */
        .bg-white.rounded-xl:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        button:active, a:active {
            transform: translateY(0);
        }

        /* Polish: Content fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-header text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-12 sm:h-16">
                <a href="index.html" class="flex items-center space-x-1 text-white hover:text-[#e8913a] transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    <span class="text-sm sm:text-base font-display">Perma<span class="text-[#e8913a]">bullish</span></span>
                </a>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <span class="text-[10px] sm:text-xs text-[#9fb3c8]">
                        <span id="reportsRemaining">-</span> left
                    </span>
                    <div id="authSection"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Limit Reached Modal -->
    <div id="limitModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Free Report Limit Reached</h3>
                <p class="text-gray-600 mb-6">You've used your free report. Sign in with Google to get 5 free reports!</p>
                <button onclick="signInWithGoogle()"
                    class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-200 rounded-xl px-4 py-3 text-gray-700 font-medium hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm mb-3">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>
                <button onclick="closeLimitModal()" class="text-gray-500 hover:text-gray-700 text-sm">
                    Maybe later
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8 fade-in">
        <!-- Limit Expired Banner (persistent, for users with no reports left) -->
        <div id="expiredBanner" class="hidden bg-gradient-to-r from-red-600 to-red-500 rounded-lg sm:rounded-xl p-3 sm:p-4 mb-4 sm:mb-6 shadow-lg">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center space-x-2 sm:space-x-3 min-w-0">
                    <div class="bg-white/20 rounded-full p-1.5 sm:p-2 flex-shrink-0">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <div class="min-w-0">
                        <p class="font-semibold text-white text-xs sm:text-base truncate" id="expiredBannerTitle">Your report limit has been reached</p>
                        <p class="text-[10px] sm:text-sm text-white/80 truncate" id="expiredBannerText">Upgrade to continue generating reports</p>
                    </div>
                </div>
                <a href="pricing.html" class="bg-white text-red-600 px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg font-semibold hover:bg-red-50 transition-colors text-xs sm:text-sm whitespace-nowrap flex-shrink-0 shadow-md">
                    Upgrade
                </a>
            </div>
        </div>

        <!-- Guest Login Nudge -->
        <div id="guestNudge" class="hidden bg-gradient-to-r from-[#102a43] to-[#1e3a5f] rounded-lg sm:rounded-xl p-3 sm:p-4 mb-4 sm:mb-6 text-white">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center space-x-2 sm:space-x-3 min-w-0">
                    <div class="bg-white/20 rounded-full p-1.5 sm:p-2 flex-shrink-0">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <div class="min-w-0">
                        <p class="font-medium text-xs sm:text-base truncate">Sign in for more reports</p>
                        <p class="text-[10px] sm:text-sm text-white/70 truncate">Get 10+ reports/month free</p>
                    </div>
                </div>
                <button onclick="signInWithGoogle()" class="bg-white text-[#102a43] px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors text-xs sm:text-sm whitespace-nowrap flex-shrink-0">
                    Sign In
                </button>
            </div>
        </div>

        <!-- Upgrade Nudge (for logged-in users with low quota) -->
        <div id="upgradeNudge" class="hidden bg-gradient-to-r from-amber-500 to-orange-500 rounded-lg sm:rounded-xl p-3 sm:p-4 mb-4 sm:mb-6 text-white">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center space-x-2 sm:space-x-3 min-w-0">
                    <div class="bg-white/20 rounded-full p-1.5 sm:p-2 flex-shrink-0">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <div class="min-w-0">
                        <p class="font-medium text-xs sm:text-base truncate" id="upgradeNudgeTitle">Running low on reports</p>
                        <p class="text-[10px] sm:text-sm text-white/80 truncate" id="upgradeNudgeText">Upgrade & save up to 30%</p>
                    </div>
                </div>
                <a href="pricing.html" class="bg-white text-orange-600 px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors text-xs sm:text-sm whitespace-nowrap flex-shrink-0">
                    Upgrade
                </a>
            </div>
        </div>

        <!-- Search Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Search for a Company</h2>

            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search by company name or symbol (e.g., TCS, Reliance)"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#e8913a] focus:border-[#e8913a] outline-none transition-all"
                    autocomplete="off">
                <div id="searchSpinner" class="hidden absolute right-4 top-3.5">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-[#e8913a]"></div>
                </div>
            </div>

            <!-- Search Results -->
            <div id="searchResults" class="hidden mt-2 border border-gray-200 rounded-lg search-results">
                <!-- Results will be inserted here -->
            </div>
        </div>

        <!-- Selected Stock Preview -->
        <div id="stockPreview" class="hidden bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6 mb-4 sm:mb-6">

            <div class="flex items-start justify-between mb-4 sm:mb-6">
                <div class="min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span id="previewTicker" class="text-sm sm:text-base font-bold text-[#e8913a] bg-[#fdecd4] px-2 py-0.5 rounded">TCS</span>
                        <span id="previewSector" class="text-xs text-gray-400 truncate">Sector</span>
                    </div>
                    <h3 id="previewName" class="text-base sm:text-lg font-semibold text-gray-900 truncate">Company Name</h3>
                </div>
            </div>

            <div class="flex items-center justify-between gap-4 mb-4 sm:mb-6 py-3 px-4 bg-gray-50 rounded-lg">
                <div class="text-center flex-1">
                    <p class="text-[10px] sm:text-xs text-gray-400 uppercase">Price</p>
                    <p id="previewPrice" class="text-sm sm:text-lg font-semibold text-gray-900">₹0</p>
                </div>
                <div class="w-px h-8 bg-gray-200"></div>
                <div class="text-center flex-1">
                    <p class="text-[10px] sm:text-xs text-gray-400 uppercase">M.Cap</p>
                    <p id="previewMarketCap" class="text-sm sm:text-lg font-semibold text-gray-900">₹0</p>
                </div>
                <div class="w-px h-8 bg-gray-200"></div>
                <div class="text-center flex-1">
                    <p class="text-[10px] sm:text-xs text-gray-400 uppercase">P/E</p>
                    <p id="previewPE" class="text-sm sm:text-lg font-semibold text-gray-900">0x</p>
                </div>
            </div>

            <div class="flex space-x-3">
                <button id="generateBtn" onclick="generateReport()"
                    class="flex-1 py-3 px-4 bg-[#e8913a] hover:bg-[#d97316] text-white font-medium rounded-lg transition-all focus:ring-4 focus:ring-[#fdecd4] flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span id="generateBtnText">Generate AI Research Report</span>
                </button>
                <button id="watchlistBtn" onclick="toggleWatchlist()" title="Add to Watchlist"
                    class="hidden py-3 px-4 border-2 border-gray-200 hover:border-[#e8913a] text-gray-600 hover:text-[#e8913a] font-medium rounded-lg transition-all">
                    <svg id="watchlistIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                    </svg>
                </button>
            </div>

            <!-- Cached report notice -->
            <div id="cachedNotice" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">
                    <span class="font-medium">Cached report available!</span>
                    A report for this stock was generated <span id="cachedDate">recently</span>.
                    <span id="cachedAction"></span>
                </p>
            </div>
        </div>

        <!-- Generation Progress -->
        <div id="generationProgress" class="hidden bg-white rounded-xl shadow-sm border border-gray-100 p-8">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-[#e8913a] mx-auto mb-6"></div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Generating Your Report</h3>
                <p id="progressText" class="text-gray-500">Fetching stock data from Yahoo Finance...</p>
                <div class="mt-6 space-y-2">
                    <div id="step1" class="flex items-center justify-center space-x-2 text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Fetching financial data</span>
                    </div>
                    <div id="step2" class="flex items-center justify-center space-x-2 text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>AI analyzing fundamentals</span>
                    </div>
                    <div id="step3" class="flex items-center justify-center space-x-2 text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Generating research report</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-xl p-6">
            <div class="flex items-start space-x-3">
                <svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="font-semibold text-red-800">Error</h3>
                    <p id="errorText" class="text-red-600 mt-1">Something went wrong</p>
                    <button onclick="location.reload()" class="mt-3 text-sm text-red-700 underline hover:no-underline">Try again</button>
                </div>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
        // API_BASE is now loaded from config.js
        let selectedStock = null;
        let searchTimeout = null;
        let cachedReport = null;
        let isInWatchlist = false;
        let forceRegenerate = false;

        // Auth state
        const token = localStorage.getItem('token');
        const isLoggedIn = !!token;

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthUI();
            updateUsageDisplay();

            // Setup search input
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('searchInput').addEventListener('focus', () => {
                const results = document.getElementById('searchResults');
                if (results.children.length > 0) {
                    results.classList.remove('hidden');
                }
            });

            // Check URL params for pre-selected stock
            const urlParams = new URLSearchParams(window.location.search);
            const ticker = urlParams.get('ticker');
            const exchange = urlParams.get('exchange') || 'NSE';
            forceRegenerate = urlParams.get('regenerate') === 'true';

            if (ticker) {
                // Pre-select stock from URL
                selectStock(ticker, ticker, '', exchange);
            }
        });

        function updateAuthUI() {
            const authSection = document.getElementById('authSection');
            if (isLoggedIn) {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                authSection.innerHTML = `
                    <a href="dashboard.html" class="hidden sm:inline text-xs sm:text-sm text-[#9fb3c8] hover:text-white">Dashboard</a>
                    <span class="hidden sm:inline text-[#334e68]">|</span>
                    <button onclick="logout()" class="text-xs sm:text-sm bg-white/10 hover:bg-white/20 px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg transition-all">
                        Logout
                    </button>
                `;
            } else {
                authSection.innerHTML = `
                    <a href="index.html" class="text-xs sm:text-sm bg-[#e8913a] hover:bg-[#d97316] px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg transition-all">
                        Sign In
                    </a>
                `;
            }
        }

        async function updateUsageDisplay() {
            const remainingEl = document.getElementById('reportsRemaining');
            const guestNudge = document.getElementById('guestNudge');
            const upgradeNudge = document.getElementById('upgradeNudge');
            const expiredBanner = document.getElementById('expiredBanner');

            if (isLoggedIn) {
                guestNudge.classList.add('hidden');

                // Fetch subscription status for authenticated users
                try {
                    const response = await apiCall('/subscription/status');
                    if (response.ok) {
                        const status = await response.json();
                        remainingEl.textContent = status.reports_remaining;

                        const tier = status.tier || 'free';

                        // Check for expired subscription or exhausted limits first
                        if (status.is_expired) {
                            // Paid subscription expired
                            document.getElementById('expiredBannerTitle').textContent = 'Your subscription has expired';
                            document.getElementById('expiredBannerText').textContent = 'Renew to continue generating reports';
                            expiredBanner.classList.remove('hidden');
                            upgradeNudge.classList.add('hidden');
                        } else if (status.reports_remaining === 0) {
                            // No reports left
                            if (tier === 'free') {
                                document.getElementById('expiredBannerTitle').textContent = "You've used all free reports";
                                document.getElementById('expiredBannerText').textContent = 'Upgrade to continue generating reports';
                            } else {
                                document.getElementById('expiredBannerTitle').textContent = 'Monthly limit reached';
                                document.getElementById('expiredBannerText').textContent = `Resets on ${status.reset_date}`;
                            }
                            expiredBanner.classList.remove('hidden');
                            upgradeNudge.classList.add('hidden');
                        } else {
                            expiredBanner.classList.add('hidden');

                            // Show upgrade nudge if low on reports (<=3 remaining or used >70%)
                            const usedPercent = status.reports_limit > 0 ? (status.reports_used / status.reports_limit) * 100 : 0;

                            if (tier !== 'enterprise' && (status.reports_remaining <= 3 || usedPercent >= 70)) {
                                upgradeNudge.classList.remove('hidden');
                                if (status.reports_remaining <= 3) {
                                    document.getElementById('upgradeNudgeTitle').textContent = `Only ${status.reports_remaining} report${status.reports_remaining > 1 ? 's' : ''} left`;
                                    document.getElementById('upgradeNudgeText').textContent = 'Upgrade for more reports - save up to 30% yearly';
                                }
                            } else {
                                upgradeNudge.classList.add('hidden');
                            }
                        }
                    }
                } catch (e) {
                    remainingEl.textContent = '-';
                }
            } else {
                upgradeNudge.classList.add('hidden');
                expiredBanner.classList.add('hidden');

                // Fetch anonymous usage from server
                try {
                    const response = await apiCall('/usage/anonymous');
                    if (response.ok) {
                        const usage = await response.json();
                        remainingEl.textContent = usage.reports_remaining;

                        // Show guest nudge - guests only get 1 report, encourage sign in
                        guestNudge.classList.remove('hidden');

                        if (usage.reports_remaining === 0) {
                            showLimitModal();
                        }
                    }
                } catch (e) {
                    remainingEl.textContent = '1';
                    // Show nudge for new users
                    guestNudge.classList.remove('hidden');
                }
            }
        }

        function showLimitModal() {
            document.getElementById('limitModal').classList.remove('hidden');
        }

        function closeLimitModal() {
            document.getElementById('limitModal').classList.add('hidden');
        }

        function signInWithGoogle() {
            window.location.href = `${API_BASE}/auth/google/login`;
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#searchInput') && !e.target.closest('#searchResults')) {
                document.getElementById('searchResults').classList.add('hidden');
            }
        });

        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            // Add Authorization header if logged in
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers
            });

            // Handle auth errors
            if (response.status === 401 && token) {
                logout();
                return response;
            }

            return response;
        }

        function handleSearch(e) {
            const query = e.target.value.trim();
            const spinner = document.getElementById('searchSpinner');
            const results = document.getElementById('searchResults');

            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length < 1) {
                results.classList.add('hidden');
                return;
            }

            spinner.classList.remove('hidden');

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await apiCall(`/stocks/search?q=${encodeURIComponent(query)}`);
                    const stocks = await response.json();

                    if (stocks.length === 0) {
                        results.innerHTML = `
                            <div class="p-4 text-center text-gray-500">
                                No stocks found. Try entering the exact NSE symbol.
                            </div>
                        `;
                    } else {
                        results.innerHTML = stocks.map(stock => `
                            <div onclick="selectStock('${stock.symbol}', '${stock.name}', '${stock.sector}')"
                                class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0 flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-900">${stock.name}</p>
                                    <p class="text-sm text-gray-500">${stock.symbol} | ${stock.sector}</p>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        `).join('');
                    }

                    results.classList.remove('hidden');
                } catch (error) {
                    console.error('Search failed:', error);
                    results.innerHTML = `
                        <div class="p-4 text-center text-red-500">
                            Search failed. Please try again.
                        </div>
                    `;
                    results.classList.remove('hidden');
                } finally {
                    spinner.classList.add('hidden');
                }
            }, 300);
        }

        async function selectStock(symbol, name, sector, exchange = 'NSE') {
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('searchInput').value = name || symbol;

            // Show loading state
            const preview = document.getElementById('stockPreview');
            preview.classList.remove('hidden');
            document.getElementById('previewTicker').textContent = symbol;
            document.getElementById('previewName').textContent = name || symbol;
            document.getElementById('previewSector').textContent = sector || 'Loading...';
            document.getElementById('previewPrice').textContent = 'Loading...';
            document.getElementById('previewMarketCap').textContent = 'Loading...';
            document.getElementById('previewPE').textContent = 'Loading...';

            // Reset cached report state
            cachedReport = null;
            document.getElementById('cachedNotice').classList.add('hidden');

            try {
                const response = await apiCall(`/stocks/${symbol}?exchange=${exchange}`);
                const data = await response.json();

                selectedStock = {
                    symbol: data.symbol || symbol,
                    name: data.company_name || name || symbol,
                    sector: data.sector || sector,
                    exchange: exchange
                };

                document.getElementById('previewTicker').textContent = data.symbol || symbol;
                document.getElementById('previewName').textContent = data.company_name || name || symbol;
                document.getElementById('previewSector').textContent = data.sector || sector || '-';
                document.getElementById('previewPrice').textContent = `₹${data.current_price?.toLocaleString('en-IN', {maximumFractionDigits: 2}) || '0'}`;
                document.getElementById('previewMarketCap').textContent = formatMarketCap(data.market_cap);
                document.getElementById('previewPE').textContent = `${data.pe_ratio?.toFixed(1) || '0'}x`;

                // Check for cached report
                await checkCachedReport(symbol, exchange);

                // Check watchlist status (only for logged in users)
                if (isLoggedIn) {
                    await checkWatchlistStatus(symbol, exchange);
                }

            } catch (error) {
                console.error('Failed to fetch stock info:', error);
                // Use basic info
                selectedStock = { symbol, name: name || symbol, sector, exchange };
                document.getElementById('previewPrice').textContent = 'N/A';
                document.getElementById('previewMarketCap').textContent = 'N/A';
                document.getElementById('previewPE').textContent = 'N/A';
            }
        }

        async function checkCachedReport(ticker, exchange) {
            try {
                const response = await apiCall(`/reports/cached/${ticker}?exchange=${exchange}`);
                if (response.ok) {
                    cachedReport = await response.json();

                    // For guests: don't show notice, just store the cached report
                    // They'll be redirected when they click Generate
                    if (!isLoggedIn) {
                        return;
                    }

                    // For logged-in users: show the notice
                    const notice = document.getElementById('cachedNotice');
                    const dateSpan = document.getElementById('cachedDate');
                    const actionSpan = document.getElementById('cachedAction');
                    const btnText = document.getElementById('generateBtnText');

                    const generatedDate = new Date(cachedReport.generated_at);
                    const daysAgo = Math.floor((Date.now() - generatedDate) / (1000 * 60 * 60 * 24));

                    dateSpan.textContent = daysAgo === 0 ? 'today' : daysAgo === 1 ? 'yesterday' : `${daysAgo} days ago`;

                    if (cachedReport.is_outdated || forceRegenerate) {
                        actionSpan.textContent = 'Click "Regenerate" to get a fresh report (uses 1 credit).';
                        btnText.textContent = 'Regenerate Report';
                    } else {
                        actionSpan.innerHTML = `<a href="report.html?id=${cachedReport.id}" class="underline font-medium">View cached report</a> or generate a fresh one.`;
                        btnText.textContent = 'Generate Fresh Report';
                    }

                    notice.classList.remove('hidden');
                }
            } catch (e) {
                // No cached report, that's fine
                document.getElementById('generateBtnText').textContent = 'Generate AI Research Report';
            }
        }

        async function checkWatchlistStatus(ticker, exchange) {
            const watchlistBtn = document.getElementById('watchlistBtn');
            watchlistBtn.classList.remove('hidden');

            try {
                const response = await apiCall(`/watchlist/check/${ticker}?exchange=${exchange}`);
                if (response.ok) {
                    const data = await response.json();
                    isInWatchlist = data.in_watchlist;
                    updateWatchlistButton();
                }
            } catch (e) {
                console.error('Failed to check watchlist:', e);
            }
        }

        function updateWatchlistButton() {
            const btn = document.getElementById('watchlistBtn');
            const icon = document.getElementById('watchlistIcon');

            if (isInWatchlist) {
                btn.classList.add('border-[#e8913a]', 'text-[#e8913a]');
                btn.classList.remove('border-gray-200', 'text-gray-600');
                icon.setAttribute('fill', 'currentColor');
                btn.title = 'Remove from Watchlist';
            } else {
                btn.classList.remove('border-[#e8913a]', 'text-[#e8913a]');
                btn.classList.add('border-gray-200', 'text-gray-600');
                icon.setAttribute('fill', 'none');
                btn.title = 'Add to Watchlist';
            }
        }

        async function toggleWatchlist() {
            if (!selectedStock || !isLoggedIn) return;

            try {
                if (isInWatchlist) {
                    await apiCall(`/watchlist/${selectedStock.symbol}?exchange=${selectedStock.exchange}`, { method: 'DELETE' });
                    isInWatchlist = false;
                } else {
                    await apiCall('/watchlist', {
                        method: 'POST',
                        body: JSON.stringify({
                            ticker: selectedStock.symbol,
                            exchange: selectedStock.exchange,
                            company_name: selectedStock.name
                        })
                    });
                    isInWatchlist = true;
                }
                updateWatchlistButton();
            } catch (e) {
                console.error('Failed to update watchlist:', e);
            }
        }

        function clearSelection() {
            selectedStock = null;
            document.getElementById('stockPreview').classList.add('hidden');
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').focus();
        }

        async function generateReport() {
            if (!selectedStock) return;

            // For guests: if there's a fresh cached report, redirect to it
            if (!isLoggedIn && cachedReport && !cachedReport.is_outdated) {
                window.location.href = `report.html?id=${cachedReport.id}`;
                return;
            }

            const btn = document.getElementById('generateBtn');
            const preview = document.getElementById('stockPreview');
            const progress = document.getElementById('generationProgress');
            const errorDiv = document.getElementById('errorMessage');

            btn.disabled = true;
            preview.classList.add('hidden');
            progress.classList.remove('hidden');
            errorDiv.classList.add('hidden');

            // Animate steps
            setTimeout(() => {
                document.getElementById('step1').classList.remove('text-gray-400');
                document.getElementById('step1').classList.add('text-green-600');
                document.getElementById('progressText').textContent = 'Analyzing financial data with AI...';
            }, 1000);

            setTimeout(() => {
                document.getElementById('step2').classList.remove('text-gray-400');
                document.getElementById('step2').classList.add('text-green-600');
                document.getElementById('progressText').textContent = 'Generating research report...';
            }, 3000);

            try {
                const requestBody = {
                    symbol: selectedStock.symbol,
                    exchange: selectedStock.exchange || 'NSE',
                    force_regenerate: forceRegenerate
                };
                console.log('Generating report with:', requestBody);

                const response = await apiCall('/reports/generate', {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('API Error:', response.status, error);
                    // Handle FastAPI validation errors (detail is array) or regular errors (detail is string)
                    let errorMessage = 'Failed to generate report';
                    if (typeof error.detail === 'string') {
                        errorMessage = error.detail;
                    } else if (Array.isArray(error.detail)) {
                        errorMessage = error.detail.map(e => e.msg || e.message).join(', ');
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                document.getElementById('step3').classList.remove('text-gray-400');
                document.getElementById('step3').classList.add('text-green-600');

                if (result.generated_new) {
                    document.getElementById('progressText').textContent = 'Fresh report generated!';
                } else {
                    document.getElementById('progressText').textContent = 'Using cached report!';
                }

                // Redirect to report view
                setTimeout(() => {
                    window.location.href = `report.html?id=${result.report_cache_id}`;
                }, 1000);

            } catch (error) {
                console.error('Failed to generate report:', error);
                progress.classList.add('hidden');

                // Check if it's a limit error
                if (error.message.includes('limit reached') || error.message.includes('Please sign in')) {
                    showLimitModal();
                } else {
                    errorDiv.classList.remove('hidden');
                    document.getElementById('errorText').textContent = error.message;
                }
            } finally {
                // Refresh usage display after generation attempt
                updateUsageDisplay();
            }
        }

        function formatMarketCap(cap) {
            if (!cap) return 'N/A';
            if (cap >= 1e12) return `₹${(cap/1e12).toFixed(2)}L Cr`;
            if (cap >= 1e9) return `₹${(cap/1e7).toFixed(0)} Cr`;
            if (cap >= 1e7) return `₹${(cap/1e7).toFixed(2)} Cr`;
            return `₹${(cap/1e5).toFixed(2)} L`;
        }
    </script>
</body>
</html>
