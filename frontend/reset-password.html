<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Permabullish</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Serif+Display&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #102a43 0%, #1e3a5f 50%, #243b53 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        body {
            font-family: 'DM Sans', 'Inter', system-ui, sans-serif;
        }
        .font-display {
            font-family: 'DM Serif Display', Georgia, serif;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        input:focus {
            box-shadow: 0 0 0 3px rgba(232, 145, 58, 0.2);
        }
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 0.6s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full fade-in">
        <!-- Logo -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-white rounded-2xl shadow-lg mb-4">
                <svg class="w-8 h-8 text-[#e8913a]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <h1 class="text-3xl font-display text-white mb-2">
                <span>Perma</span><span class="text-[#e8913a]">bullish</span>
            </h1>
        </div>

        <div class="glass-card rounded-2xl shadow-2xl p-8">
            <!-- Error/Success Messages -->
            <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
                <p id="errorText"></p>
            </div>

            <!-- Mode 1: Request Reset (no token) -->
            <div id="requestMode" class="hidden">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-50 rounded-full mb-3">
                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-[#1e3a5f]">Forgot your password?</h2>
                    <p class="text-gray-500 text-sm mt-1">Enter your email and we'll send you a reset link.</p>
                </div>

                <form onsubmit="handleForgotPassword(event)">
                    <div class="space-y-3">
                        <input type="email" id="forgotEmail" placeholder="Email address" required
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-gray-700 placeholder-gray-400 focus:outline-none focus:border-[#e8913a]">
                        <button type="submit" id="forgotBtn"
                            class="w-full bg-[#e8913a] text-white font-semibold py-3 rounded-xl hover:bg-[#d97316] transition-all">
                            Send Reset Link
                        </button>
                    </div>
                </form>

                <!-- Sent confirmation (hidden initially) -->
                <div id="sentConfirmation" class="hidden mt-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-green-700">
                            If an account exists with that email, we've sent a password reset link.
                        </p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-sm text-yellow-800">
                            <strong>Can't find it?</strong> Check your spam or promotions folder.
                        </p>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a href="index.html" class="text-sm text-gray-500 hover:text-[#e8913a]">Back to sign in</a>
                </div>
            </div>

            <!-- Mode 2: Set New Password (with token) -->
            <div id="resetMode" class="hidden">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-50 rounded-full mb-3">
                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-[#1e3a5f]">Set new password</h2>
                    <p class="text-gray-500 text-sm mt-1">Choose a strong password for your account.</p>
                </div>

                <form onsubmit="handleResetPassword(event)">
                    <div class="space-y-3">
                        <input type="password" id="newPassword" placeholder="New password (min 8 characters)" required minlength="8"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-gray-700 placeholder-gray-400 focus:outline-none focus:border-[#e8913a]">
                        <input type="password" id="confirmPassword" placeholder="Confirm new password" required minlength="8"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-gray-700 placeholder-gray-400 focus:outline-none focus:border-[#e8913a]">
                        <button type="submit" id="resetBtn"
                            class="w-full bg-[#e8913a] text-white font-semibold py-3 rounded-xl hover:bg-[#d97316] transition-all">
                            Reset Password
                        </button>
                    </div>
                </form>

                <div class="text-center mt-4">
                    <a href="index.html" class="text-sm text-gray-500 hover:text-[#e8913a]">Back to sign in</a>
                </div>
            </div>

            <!-- Mode 3: Success -->
            <div id="successMode" class="hidden">
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-50 rounded-full mb-4">
                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-[#1e3a5f] mb-2">Password reset!</h2>
                    <p class="text-gray-600 mb-6">Your password has been updated. You can now sign in with your new password.</p>

                    <a href="index.html"
                        class="block w-full bg-[#e8913a] text-white font-semibold py-3 rounded-xl hover:bg-[#d97316] transition-all text-center">
                        Sign in
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token) {
            document.getElementById('resetMode').classList.remove('hidden');
        } else {
            document.getElementById('requestMode').classList.remove('hidden');
        }

        function showError(msg) {
            const el = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = msg;
            el.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function setButtonLoading(btn, loading) {
            if (loading) {
                btn.disabled = true;
                btn.dataset.originalText = btn.textContent;
                btn.innerHTML = '<span class="spinner"></span>';
            } else {
                btn.disabled = false;
                btn.textContent = btn.dataset.originalText || btn.textContent;
            }
        }

        async function handleForgotPassword(e) {
            e.preventDefault();
            hideError();
            const btn = document.getElementById('forgotBtn');
            setButtonLoading(btn, true);

            try {
                const res = await fetch(`${API_BASE}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('forgotEmail').value
                    })
                });

                // Always show success (don't reveal if email exists)
                document.getElementById('sentConfirmation').classList.remove('hidden');
                btn.classList.add('hidden');
            } catch (err) {
                showError('Network error. Please try again.');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function handleResetPassword(e) {
            e.preventDefault();
            hideError();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showError('Passwords do not match.');
                return;
            }

            if (newPassword.length < 8) {
                showError('Password must be at least 8 characters.');
                return;
            }

            const btn = document.getElementById('resetBtn');
            setButtonLoading(btn, true);

            try {
                const res = await fetch(`${API_BASE}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        new_password: newPassword
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    showError(data.detail || 'Failed to reset password.');
                    return;
                }

                // Show success
                document.getElementById('resetMode').classList.add('hidden');
                document.getElementById('successMode').classList.remove('hidden');
            } catch (err) {
                showError('Network error. Please try again.');
            } finally {
                setButtonLoading(btn, false);
            }
        }
    </script>
</body>
</html>
